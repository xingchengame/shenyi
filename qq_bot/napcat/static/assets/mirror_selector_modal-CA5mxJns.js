import{h as d,j as t}from"./codemirror-core-DIzFijqu.js";import{p as v,k as P,S as $,q as I,v as q,x as A,b as w,y as B,z as G}from"./index-B0DyBq9P.js";import{c as M}from"./chunk-NAV3ZXLI-VwA3667I.js";import{t as H}from"./chunk-6LIX6LVT-v4ufXNaW.js";import{d as J,j as O,c as U}from"./index-OutTOxJU.js";import{c as D}from"./react-dom-TsCL3mk_.js";class z{static async getMirrorList(){const{data:s}=await v.get("/Mirror/List");return s.data}static async setCustomMirror(s){await v.post("/Mirror/SetCustom",{mirror:s})}static async testSingleMirror(s,r="file"){const{data:o}=await v.post("/Mirror/Test",{mirror:s,type:r});return o.data}static testMirrorsSSE(s="file",r){const o=localStorage.getItem(P.token);if(!o)throw new Error("未登录");const u=JSON.parse(o),a=new $.EventSourcePolyfill(`/api/Mirror/Test/SSE?type=${s}`,{headers:{Authorization:`Bearer ${u}`,Accept:"text/event-stream"},withCredentials:!0});return a.onmessage=c=>{var l,m,x,h,f;try{const i=JSON.parse(c.data);switch(i.type){case"start":(l=r.onStart)==null||l.call(r,i);break;case"testing":(m=r.onTesting)==null||m.call(r,i);break;case"result":(x=r.onResult)==null||x.call(r,i);break;case"complete":(h=r.onComplete)==null||h.call(r,i),a.close();break;case"error":(f=r.onError)==null||f.call(r,i.error),a.close();break}}catch(i){console.error("Failed to parse SSE message:",i)}},a.onerror=c=>{var l;console.error("SSE连接出错:",c),(l=r.onError)==null||l.call(r,"连接中断"),a.close()},a}}function b({isOpen:n,onClose:s,onSelect:r,currentMirror:o,type:u="file"}){const[a,c]=d.useState([]),[l,m]=d.useState(o||"auto"),[x,h]=d.useState(new Map),[f,i]=d.useState(!1),[C,j]=d.useState(0),[T,p]=d.useState(""),[N,E]=d.useState(null);d.useEffect(()=>{n&&R()},[n]);const R=async()=>{try{const e=await z.getMirrorList(),g=u==="raw"?e.rawMirrors:e.fileMirrors;c(g),e.customMirror&&m(e.customMirror)}catch(e){console.error("Failed to load mirrors:",e)}},L=()=>{i(!0),j(0),h(new Map),E(null),p("准备测速..."),z.testMirrorsSSE(u,{onStart:e=>{p(e.message)},onTesting:e=>{j(e.index/e.total*100),p(e.message)},onResult:e=>{h(g=>{const S=new Map(g);return S.set(e.result.mirror,e.result),S}),j((e.index+1)/e.total*100)},onComplete:e=>{i(!1),j(100),p(e.message),e.fastest&&E(e.fastest.mirror)},onError:e=>{i(!1),p(`测速失败: ${e}`)}})},F=()=>{r(l==="auto"?void 0:l),s()};return t.jsx(I,{isOpen:n,onClose:s,size:"2xl",scrollBehavior:"inside",classNames:{backdrop:"z-[200]",wrapper:"z-[200]"},children:t.jsxs(q,{children:[t.jsxs(A,{className:"flex flex-col gap-1",children:[t.jsxs("div",{className:"flex items-center justify-between pr-8",children:[t.jsx("span",{children:"选择镜像源"}),t.jsx(w,{size:"sm",color:"primary",variant:"flat",startContent:!f&&t.jsx(J,{}),onPress:L,isLoading:f,children:f?"测速中...":"一键测速"})]}),f&&t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"w-full bg-default-200 rounded-full h-2",children:t.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${C}%`}})}),t.jsx("p",{className:"text-xs text-default-500 mt-1",children:T})]})]}),t.jsx(B,{children:t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx(y,{value:"auto",label:"自动选择",description:"系统自动选择最快的镜像源",isSelected:l==="auto",onSelect:()=>m("auto"),badge:t.jsx(M,{size:"sm",color:"primary",variant:"flat",children:"推荐"})}),t.jsx(y,{value:"https://github.com",label:"GitHub 原始",description:"直连 GitHub（可能较慢）",isSelected:l==="https://github.com",onSelect:()=>m("https://github.com"),testResult:x.get("https://github.com (原始)"),isFastest:N==="https://github.com (原始)"}),a.map(e=>{if(!e)return null;const g=x.get(e),S=N===e;let _=e;try{_=new URL(e).hostname}catch{}return t.jsx(y,{value:e,label:_,description:e,isSelected:l===e,onSelect:()=>m(e),testResult:g,isFastest:S},e)})]})}),t.jsxs(G,{children:[t.jsx(w,{variant:"light",onPress:s,children:"取消"}),t.jsx(w,{color:"primary",onPress:F,children:"确认选择"})]})]})})}function y({label:n,description:s,isSelected:r,onSelect:o,testResult:u,isFastest:a,badge:c}){return t.jsxs("div",{className:D("flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all","bg-content1 hover:bg-content2 border-2",r?"border-primary":"border-transparent",a&&"ring-2 ring-success"),onClick:o,children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium",children:n}),t.jsx("p",{className:"text-xs text-default-500 truncate",children:s})]}),t.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[c,a&&!c&&t.jsx(M,{size:"sm",color:"success",variant:"flat",children:"最快"}),u&&t.jsx(K,{result:u})]})]})}function K({result:n}){const s=o=>o>=5e3?">5s":o>=1e3?`${(o/1e3).toFixed(1)}s`:`${o}ms`;if(!n.success)return t.jsx(H,{content:n.error||"连接失败",children:t.jsx(M,{size:"sm",color:"danger",variant:"flat",startContent:t.jsx(O,{size:14}),children:"失败"})});const r=()=>n.latency<300?"success":n.latency<1e3?"warning":"danger";return t.jsx(M,{size:"sm",color:r(),variant:"flat",startContent:t.jsx(U,{size:14}),children:s(n.latency)})}export{b as M,z as a};
