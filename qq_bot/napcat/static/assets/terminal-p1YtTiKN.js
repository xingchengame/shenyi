var C=Object.defineProperty;var E=(a,e,t)=>e in a?C(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var w=(a,e,t)=>E(a,typeof e!="symbol"?e+"":e,t);import{j as o,h as u}from"./codemirror-core-DIzFijqu.js";import{c as p,aU as R,aV as z,u as P,aW as L,aX as O,aY as _,aZ as D,a_ as M,a$ as F,J as T,b0 as J,b1 as W}from"./react-dom-TsCL3mk_.js";import{p as y,k as X,b as v}from"./index-B0DyBq9P.js";import{l as A,t as N}from"./index-CtZU_f5P.js";import{X as U}from"./xterm-BzJ3ya9s.js";import"./iconBase-ClXMXqAg.js";const S=u.createContext({activeKey:"",onChange:()=>{}});function B({activeKey:a,onChange:e,children:t,className:n}){return o.jsx(S.Provider,{value:{activeKey:a,onChange:e},children:o.jsx("div",{className:p("flex flex-col gap-2",n),children:t})})}function K({children:a,className:e}){return o.jsx("div",{className:p("flex items-center gap-1",e),children:a})}const j=u.forwardRef(({className:a,isSelected:e,value:t,...n},s)=>{const{onChange:h}=u.useContext(S),l=i=>{var f;h(t),(f=n.onClick)==null||f.call(n,i)};return o.jsx("div",{ref:s,role:"tab","aria-selected":e,onClick:l,className:p("px-2 py-1 flex items-center gap-1 text-sm font-medium border-b-2 transition-colors",e?"border-primary text-primary":"border-transparent hover:border-default",a),...n})});j.displayName="Tab";function Z({value:a,children:e,className:t}){const{activeKey:n}=u.useContext(S);return a!==n?null:o.jsx("div",{className:p("flex-1",t),children:e})}function $({id:a,...e}){const{attributes:t,listeners:n,setNodeRef:s,transform:h,transition:l,isDragging:i}=R({id:a}),f={transform:z.Transform.toString(h),transition:l,zIndex:i?1:0,position:"relative",touchAction:"none"};return o.jsx(j,{ref:s,style:f,...t,...n,...e})}class q{constructor(){w(this,"connections",new Map);w(this,"MAX_BUFFER_SIZE",1e3)}async createTerminal(e,t){const{data:n}=await y.post("/Log/terminal/create",{cols:e,rows:t});return n.data}async closeTerminal(e){await y.post(`/Log/terminal/${e}/close`)}async getTerminalList(){const{data:e}=await y.get("/Log/terminal/list");return e.data}connectTerminal(e,t,n){let s=this.connections.get(e);const{cols:h=80,rows:l=24}=n||{};if(s)s.callbacks.add(t),s.buffer.forEach(i=>t(i));else{const i=new URL(window.location.href);i.protocol=i.protocol.replace("http","ws"),i.pathname="/api/ws/terminal",i.searchParams.set("id",e);const f=JSON.parse(localStorage.getItem("token")||"");if(!f)throw new Error("No token found");i.searchParams.set("token",f);const m=new WebSocket(i.toString());s={ws:m,callbacks:new Set([t]),isConnected:!1,buffer:[]},m.onmessage=r=>{const d=r.data;s==null||s.buffer.push(d),((s==null?void 0:s.buffer.length)??0)>this.MAX_BUFFER_SIZE&&(s==null||s.buffer.shift()),s==null||s.callbacks.forEach(c=>c(d))},m.onopen=()=>{s&&(s.isConnected=!0),this.sendResize(e,h,l)},m.onclose=()=>{s&&(s.isConnected=!1)},this.connections.set(e,s)}return s.ws}disconnectTerminal(e,t){const n=this.connections.get(e);n&&n.callbacks.delete(t)}removeTerminal(e){const t=this.connections.get(e);(t==null?void 0:t.ws.readyState)===WebSocket.OPEN&&t.ws.close(),this.connections.delete(e)}sendInput(e,t){const n=this.connections.get(e);(n==null?void 0:n.ws.readyState)===WebSocket.OPEN&&n.ws.send(JSON.stringify({type:"input",data:t}))}sendResize(e,t,n){const s=this.connections.get(e);(s==null?void 0:s.ws.readyState)===WebSocket.OPEN&&s.ws.send(JSON.stringify({type:"resize",cols:t,rows:n}))}}const x=new q;function V({id:a}){const e=u.useRef(null),t=u.useRef(!1),n=l=>{var i,f;try{const m=JSON.parse(l);m.data&&((i=e.current)==null||i.write(m.data))}catch{(f=e.current)==null||f.write(l)}};u.useEffect(()=>()=>{t.current&&x.disconnectTerminal(a,n)},[a]);const s=l=>{x.sendInput(a,l)},h=(l,i)=>{t.current?x.sendResize(a,l,i):(t.current=!0,console.log("instance",i,l),x.connectTerminal(a,n,{rows:i,cols:l}))};return o.jsx(U,{ref:e,onInput:s,onResize:h,className:"w-full h-full"})}function ne(){const[a,e]=u.useState([]),[t,n]=u.useState(""),[s]=P(X.backgroundImage,""),h=!!s;u.useEffect(()=>{x.getTerminalList().then(r=>{if(r.length===0)return;const d=r.map(c=>({id:c.id,title:c.id}));e(d),n(d[0].id)})},[]);const l=async()=>{try{const{id:r}=await x.createTerminal(80,24),d={id:r,title:r};e(c=>[...c,d]),n(r)}catch(r){console.error("Failed to create terminal:",r),T.error(r.message)}},i=async r=>{var d;try{if(await x.closeTerminal(r),x.removeTerminal(r),t===r){const c=a.findIndex(g=>g.id===r)-1;c>=0?n(a[c].id):n(((d=a[0])==null?void 0:d.id)||"")}e(c=>c.filter(g=>g.id!==r))}catch{T.error("关闭终端失败")}},f=r=>{const{active:d,over:c}=r;d.id!==(c==null?void 0:c.id)&&e(g=>{const k=g.findIndex(b=>b.id===d.id),I=g.findIndex(b=>b.id===(c==null?void 0:c.id));return J(g,k,I)})},m=L(O(W,{activationConstraint:{distance:8}}));return o.jsx("div",{className:"flex flex-col gap-2 p-4 h-[calc(100vh-6rem)] md:h-[calc(100vh-4rem)]",children:o.jsx(_,{sensors:m,collisionDetection:D,onDragEnd:f,children:o.jsxs(B,{activeKey:t,onChange:n,className:"h-full overflow-hidden",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0 flex-grow-0",children:[a.length>0&&o.jsx(K,{className:p("flex-1 !overflow-x-auto w-full hide-scrollbar backdrop-blur-sm p-1 rounded-lg border border-white/20",h?"bg-white/20 dark:bg-black/10":"bg-white/40 dark:bg-black/20"),children:o.jsx(M,{items:a,strategy:F,children:a.map(r=>o.jsxs($,{id:r.id,value:r.id,isSelected:t===r.id,className:"flex gap-2 items-center flex-shrink-0",children:[r.title,o.jsx(v,{isIconOnly:!0,radius:"full",variant:"flat",size:"sm",className:"min-w-0 w-4 h-4 flex-shrink-0",onPress:()=>i(r.id),color:t===r.id?"primary":"default",children:o.jsx(A,{})})]},r.id))})}),o.jsx(v,{isIconOnly:!0,color:"primary",size:"sm",variant:"flat",onPress:l,startContent:o.jsx(N,{}),className:"text-xl ml-auto"})]}),o.jsxs("div",{className:"flex-grow overflow-hidden",children:[a.length===0&&o.jsxs("div",{className:"flex flex-col gap-2 items-center justify-center h-full text-gray-500 py-5",children:[o.jsx(N,{className:"text-4xl"}),o.jsx("div",{className:"text-sm",children:"点击右上角按钮创建终端"})]}),a.map(r=>o.jsx(Z,{value:r.id,className:"h-full",children:o.jsx(V,{id:r.id})},r.id))]})]})})})}export{ne as default};
