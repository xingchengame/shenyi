import{h as l,j as e}from"./codemirror-core-DIzFijqu.js";import{b as L,s as G,k as H,S as X}from"./index-B0DyBq9P.js";import{i as Y}from"./chunk-2QAN2V2R-DjiYH11d.js";import{t as Z,a as ee}from"./chunk-ML27DD5T-CMfbU3IH.js";import{b as te,a as se}from"./chunk-5PILOUBS-C2iqzQ1E.js";import{t as ae}from"./chunk-6LIX6LVT-v4ufXNaW.js";import{J as i,c as re}from"./react-dom-TsCL3mk_.js";import{g as le,h as $,a as R,e as ne,i as ie}from"./index-OutTOxJU.js";import{c as I}from"./chunk-NAV3ZXLI-VwA3667I.js";import{D as oe}from"./container-DwknEHbI.js";import{P as z}from"./plugin_manager-DEZ81PoC.js";import{M as F}from"./mirror_selector_modal-CA5mxJns.js";import{u as de}from"./use-dialog-CRavAmtS.js";import"./chunk-CAFRINWI-CcU5yOMx.js";import"./chunk-SLABUSGS-BX9EgnNv.js";import"./chunk-M3MASYO7-BtOvSeRL.js";import"./chunk-WQVQ7P2I-B4KcTpLM.js";import"./index-CokAva9Y.js";import"./Item-DvdRZmps.js";import"./iconBase-ClXMXqAg.js";const ce=({data:u,onInstall:N,installStatus:m="not-installed"})=>{const{name:k,version:x,author:b,description:o,tags:f,id:j}=u,[w,v]=l.useState(!1),S=()=>{v(!0),N().finally(()=>v(!1))},g=(()=>{switch(m){case"installed":return{text:"重新安装",icon:e.jsx(R,{size:16}),color:"default"};case"update-available":return{text:"更新",icon:e.jsx($,{size:16}),color:"success"};default:return{text:"安装",icon:e.jsx($,{size:16}),color:"primary"}}})();return e.jsx(oe,{className:"w-full max-w-[420px]",title:k,tag:e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[m==="installed"&&e.jsx(I,{color:"success",size:"sm",variant:"flat",startContent:e.jsx(le,{size:14}),children:"已安装"}),m==="update-available"&&e.jsx(I,{color:"warning",size:"sm",variant:"flat",children:"可更新"}),e.jsxs(I,{color:"primary",size:"sm",variant:"flat",children:["v",x]})]}),enableSwitch:void 0,action:e.jsx(L,{fullWidth:!0,radius:"full",size:"sm",color:g.color,startContent:g.icon,onPress:S,isLoading:w,isDisabled:w,children:g.text}),children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"作者"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:b||"未知"})]}),e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"版本"}),e.jsxs("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:["v",x]})]}),e.jsxs("div",{className:"col-span-2 flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"描述"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 break-words line-clamp-2 h-10 overflow-hidden",children:o||"暂无描述"})]}),j&&e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"包名"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 break-words line-clamp-2 h-10 overflow-hidden",children:j||"包名"})]}),f&&f.length>0&&e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"标签"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:f.slice(0,2).join(" · ")})]})]})})},ue=({isEmpty:u})=>e.jsx("div",{className:re("text-default-400",{hidden:!u}),children:"暂时没有可用的插件"});function _e(){const[u,N]=l.useState([]),[m,k]=l.useState([]),[x,b]=l.useState(!1),[o,f]=l.useState(""),[j,w]=l.useState("all"),[v,S]=l.useState(!1),_=de(),[g,E]=l.useState(!1),[h,T]=l.useState(void 0),[V,y]=l.useState(!1),[O,C]=l.useState(null),[A,B]=l.useState(void 0),P=async()=>{b(!0);try{const t=await z.getPluginStoreList();N(t.plugins);const r=await z.getPluginList();S(r.pluginManagerNotFound),k(r.plugins||[])}catch(t){i.error(t.message)}finally{b(!1)}};l.useEffect(()=>{P()},[h]);const d=l.useMemo(()=>{let t=u;return o&&(t=t.filter(s=>{var a;return s.name.toLowerCase().includes(o.toLowerCase())||s.description.toLowerCase().includes(o.toLowerCase())||s.author.toLowerCase().includes(o.toLowerCase())||((a=s.tags)==null?void 0:a.some(n=>n.toLowerCase().includes(o.toLowerCase())))})),{all:t,official:t.filter(s=>{var a;return(a=s.tags)==null?void 0:a.includes("官方")}),tools:t.filter(s=>{var a;return(a=s.tags)==null?void 0:a.includes("工具")}),entertainment:t.filter(s=>{var a;return(a=s.tags)==null?void 0:a.includes("娱乐")}),other:t.filter(s=>{var a;return!((a=s.tags)!=null&&a.some(n=>["官方","工具","娱乐"].includes(n)))})}},[u,o]),J=t=>{const r=m.find(s=>s.id===t.id);return r?r.version!==t.version?{status:"update-available",installedVersion:r.version}:{status:"installed",installedVersion:r.version}:{status:"not-installed"}},U=l.useMemo(()=>{var t,r,s,a,n;return[{key:"all",title:"全部",count:((t=d.all)==null?void 0:t.length)||0},{key:"official",title:"官方",count:((r=d.official)==null?void 0:r.length)||0},{key:"tools",title:"工具",count:((s=d.tools)==null?void 0:s.length)||0},{key:"entertainment",title:"娱乐",count:((a=d.entertainment)==null?void 0:a.length)||0},{key:"other",title:"其它",count:((n=d.other)==null?void 0:n.length)||0}]},[d]),W=async t=>{C(t),y(!0)},Q=async(t,r)=>{const s=i.loading("正在准备安装...");try{const a=localStorage.getItem(H.token);if(!a){i.error("未登录，请先登录",{id:s});return}const n=JSON.parse(a),D=new URLSearchParams({id:t});r&&D.append("mirror",r);const p=new X.EventSourcePolyfill(`/api/Plugin/Store/Install/SSE?${D.toString()}`,{headers:{Authorization:`Bearer ${n}`,Accept:"text/event-stream"},withCredentials:!0});p.onmessage=M=>{try{const c=JSON.parse(M.data);c.error?(i.error(`安装失败: ${c.error}`,{id:s}),p.close()):c.success?(i.success("插件安装成功！",{id:s}),p.close(),P(),v&&_.confirm({title:"插件管理器未加载",content:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-default-600",children:"插件已安装成功，但插件管理器尚未加载。"}),e.jsx("p",{className:"text-sm text-default-600",children:"是否立即注册插件管理器？注册后插件才能正常运行。"})]}),confirmText:"注册插件管理器",cancelText:"稍后再说",onConfirm:async()=>{try{await z.registerPluginManager(),i.success("插件管理器注册成功"),S(!1)}catch(q){i.error("注册失败: "+q.message)}}})):c.message&&i.loading(c.message,{id:s})}catch(c){console.error("Failed to parse SSE message:",c)}},p.onerror=M=>{console.error("SSE连接出错:",M),i.error("连接中断，安装失败",{id:s}),p.close()}}catch(a){i.error(`安装失败: ${a.message||"未知错误"}`,{id:s})}},K=()=>{if(!h)return"默认源";try{return new URL(h).hostname}catch{return h}};return e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"插件商店 - NapCat WebUI"}),e.jsxs("div",{className:"p-2 md:p-4 relative",children:[e.jsxs("div",{className:"flex mb-6 items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"插件商店"}),e.jsx(L,{isIconOnly:!0,className:"bg-default-100/50 hover:bg-default-200/50 text-default-700 backdrop-blur-md",radius:"full",onPress:P,isLoading:x,children:e.jsx(R,{size:24})})]}),e.jsx(te,{className:"bg-default-100/50 backdrop-blur-md shadow-sm",children:e.jsx(se,{className:"py-2 px-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-default-500",children:"列表源:"}),e.jsx("span",{className:"text-sm font-medium",children:K()})]}),e.jsx(ae,{content:"切换列表源",children:e.jsx(L,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>E(!0),children:e.jsx(ne,{size:16})})})]})})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(Y,{placeholder:"搜索插件名称、描述、作者或标签...",startContent:e.jsx(ie,{className:"text-default-400"}),value:o,onValueChange:f,className:"max-w-md"})}),e.jsxs("div",{className:"relative",children:[x&&e.jsx("div",{className:"absolute inset-0 bg-zinc-500/10 z-30 flex justify-center items-center backdrop-blur-sm rounded-lg",children:e.jsx(G,{size:"lg"})}),e.jsx(Z,{"aria-label":"Plugin Store Categories",className:"max-w-full",selectedKey:j,onSelectionChange:t=>w(String(t)),classNames:{tabList:"bg-white/40 dark:bg-black/20 backdrop-blur-md",cursor:"bg-white/80 dark:bg-white/10 backdrop-blur-md shadow-sm"},children:U.map(t=>{var r,s;return e.jsxs(ee,{title:`${t.title} (${t.count})`,children:[e.jsx(ue,{isEmpty:!((r=d[t.key])!=null&&r.length)}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 justify-start items-stretch gap-x-2 gap-y-4",children:(s=d[t.key])==null?void 0:s.map(a=>{const n=J(a);return e.jsx(ce,{data:a,installStatus:n.status,installedVersion:n.installedVersion,onInstall:()=>W(a)},a.id)})})]},t.key)})})]})]}),e.jsx(F,{isOpen:g,onClose:()=>E(!1),onSelect:t=>{T(t)},currentMirror:h,type:"raw"}),e.jsx(F,{isOpen:V,onClose:()=>{y(!1),C(null)},onSelect:t=>{B(t),O&&(y(!1),Q(O.id,t),C(null))},currentMirror:A,type:"file"})]})}export{_e as default};
