import{h as r,j as s}from"./codemirror-core-DIzFijqu.js";import{b as M,k as $,S as W,q as B,v as q,x as H,y as G,z as Q,A as X,P as Y}from"./index-B0DyBq9P.js";import{J as x}from"./react-dom-TsCL3mk_.js";import{a as Z}from"./index-OutTOxJU.js";import{s as U}from"./chunk-J6JGI6RM-DVh9RltW.js";import{c as ee}from"./chunk-NAV3ZXLI-VwA3667I.js";import{l as se,m as ae}from"./index-DYKlz1bo.js";import{D as te}from"./container-DwknEHbI.js";import{P as v}from"./plugin_manager-DEZ81PoC.js";import{u as le}from"./use-dialog-CRavAmtS.js";import{i as A}from"./chunk-2QAN2V2R-DjiYH11d.js";import{s as T,l as I}from"./chunk-KVDW62ZT-CdlHxaox.js";import"./iconBase-ClXMXqAg.js";import"./chunk-EN4B57RQ-CeMxVeoS.js";import"./chunk-WQVQ7P2I-B4KcTpLM.js";import"./chunk-M3MASYO7-BtOvSeRL.js";import"./chunk-5PILOUBS-C2iqzQ1E.js";import"./chunk-CAFRINWI-CcU5yOMx.js";import"./chunk-SLABUSGS-BX9EgnNv.js";import"./Item-DvdRZmps.js";import"./chunk-AXSF7SRE-xAGcR_TS.js";const ne=({data:p,onToggleStatus:y,onUninstall:i,onConfig:S,hasConfig:w=!1})=>{const{name:m,version:d,author:b,description:j,status:g}=p,C=g==="active",[P,u]=r.useState(!1),N=()=>{u(!0),y().finally(()=>u(!1))},_=()=>{u(!0),i().finally(()=>u(!1))};return s.jsx(te,{className:"w-full max-w-[420px]",action:s.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[s.jsx("div",{className:"flex gap-2 w-full",children:s.jsx(M,{fullWidth:!0,radius:"full",size:"sm",variant:"flat",className:"flex-1 bg-default-100 dark:bg-default-50 text-default-600 font-medium hover:bg-danger/20 hover:text-danger transition-colors",startContent:s.jsx(se,{size:16}),onPress:_,isDisabled:P,children:"å¸è½½"})}),w&&s.jsx(M,{fullWidth:!0,radius:"full",size:"sm",variant:"flat",className:"bg-default-100 dark:bg-default-50 text-default-600 font-medium hover:bg-secondary/20 hover:text-secondary transition-colors",startContent:s.jsx(ae,{size:16}),onPress:S,children:"é…ç½®"})]}),enableSwitch:s.jsx(U,{isDisabled:P,isSelected:C,onChange:N,classNames:{wrapper:"group-data-[selected=true]:bg-primary-400"}}),title:m,tag:s.jsx(ee,{className:"ml-auto",color:g==="active"?"success":g==="stopped"?"warning":"default",size:"sm",variant:"flat",children:g==="active"?"è¿è¡Œä¸­":g==="stopped"?"å·²åœæ­¢":"å·²ç¦ç”¨"}),children:s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[s.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"ç‰ˆæœ¬"}),s.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:d})]}),s.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[s.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"ä½œè€…"}),s.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:b||"æœªçŸ¥"})]}),s.jsxs("div",{className:"col-span-2 flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[s.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"æè¿°"}),s.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 break-words line-clamp-2",children:j||"æš‚æ— æè¿°"})]})]})})};function re({isOpen:p,onOpenChange:y,pluginId:i}){const[S,w]=r.useState(!1),[m,d]=r.useState([]),[b,j]=r.useState({}),[g,C]=r.useState(!1),[P,u]=r.useState(!1),[N,_]=r.useState(null),[E,n]=r.useState(!1),f=r.useRef(null),F=r.useRef({});r.useEffect(()=>{F.current=b},[b]);const k=r.useCallback(e=>{switch(e.type){case"full":e.schema&&d(e.schema);break;case"updateField":e.key&&e.field&&d(l=>l.map(a=>a.key===e.key?{...a,...e.field}:a));break;case"removeField":e.key&&d(l=>l.filter(a=>a.key!==e.key));break;case"addField":e.field&&d(l=>{const a=e.field,o=l.findIndex(t=>t.key===a.key);if(o!==-1){const t=[...l];return t[o]={...t[o],...a},t}if(e.afterKey){const t=l.findIndex(c=>c.key===e.afterKey);if(t!==-1){const c=[...l];return c.splice(t+1,0,a),c}}return[...l,a]});break;case"showField":e.key&&d(l=>l.map(a=>a.key===e.key?{...a,hidden:!1}:a));break;case"hideField":e.key&&d(l=>l.map(a=>a.key===e.key?{...a,hidden:!0}:a));break}},[]),R=r.useCallback(e=>{f.current&&f.current.close();const l=localStorage.getItem($.token);if(!l){console.warn("æœªç™»å½•ï¼Œæ— æ³•å»ºç«‹ SSE è¿æ¥");return}const a=JSON.parse(l),o=v.getConfigSSEUrl(i,e),t=new W.EventSourcePolyfill(o,{headers:{Authorization:`Bearer ${a}`,Accept:"text/event-stream"},withCredentials:!0});f.current=t,t.addEventListener("connected",c=>{const h=JSON.parse(c.data);_(h.sessionId),n(!0)}),t.addEventListener("schema",c=>{const h=JSON.parse(c.data);k(h)}),t.addEventListener("error",c=>{try{const h=JSON.parse(c.data);x.error("æ’ä»¶é”™è¯¯: "+h.message)}catch{n(!1)}}),t.onerror=()=>{n(!1)}},[i,k]),z=r.useCallback(()=>{f.current&&(f.current.close(),f.current=null),_(null),n(!1)},[]);r.useEffect(()=>(p&&i&&V(),()=>{z()}),[p,i,z]);const V=async()=>{w(!0),d([]),j({}),u(!1),z();try{const e=await v.getPluginConfig(i);d(e.schema||[]),j(e.config||{}),u(!!e.supportReactive),e.supportReactive&&R(e.config||{})}catch(e){x.error("åŠ è½½é…ç½®å¤±è´¥: "+e.message)}finally{w(!1)}},J=async()=>{C(!0);try{await v.setPluginConfig(i,b),x.success("Configuration saved"),y()}catch(e){x.error("Save failed: "+e.message)}finally{C(!1)}},L=r.useCallback((e,l)=>{j(a=>{const o={...a,[e]:l},t=m.find(c=>c.key===e);return t!=null&&t.reactive&&N&&E&&v.notifyConfigChange(i,N,e,l,o).catch(c=>console.error("é€šçŸ¥é…ç½®å˜åŒ–å¤±è´¥:",c)),o})},[m,N,E,i]),K=e=>{const l=b[e.key]??e.default;switch(e.type){case"string":return s.jsx(A,{label:e.label,placeholder:e.placeholder||e.description,value:l||"",onValueChange:a=>L(e.key,a),description:e.description,className:"mb-4"},e.key);case"number":return s.jsx(A,{type:"number",label:e.label,placeholder:e.placeholder||e.description,value:String(l??0),onValueChange:a=>L(e.key,Number(a)),description:e.description,className:"mb-4"},e.key);case"boolean":return s.jsxs("div",{className:"flex justify-between items-center mb-4 p-2 bg-default-100 rounded-lg",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-small",children:e.label}),e.description&&s.jsx("span",{className:"text-tiny text-default-500",children:e.description})]}),s.jsx(U,{isSelected:!!l,onValueChange:a=>L(e.key,a)})]},e.key);case"select":{const a=l!==void 0?String(l):void 0,o=e.options||[];return s.jsx(T,{label:e.label,placeholder:e.placeholder||"Select an option",selectedKeys:a?[a]:[],onSelectionChange:t=>{const c=Array.from(t)[0],h=o.find(D=>String(D.value)===c);L(e.key,h?h.value:c)},description:e.description,className:"mb-4",children:o.map(t=>s.jsx(I,{textValue:t.label,children:t.label},String(t.value)))},e.key)}case"multi-select":{const a=Array.isArray(l)?l.map(String):[],o=e.options||[];return s.jsx(T,{label:e.label,placeholder:e.placeholder||"Select options",selectionMode:"multiple",selectedKeys:new Set(a),onSelectionChange:t=>{const c=Array.from(t).map(h=>{const D=o.find(O=>String(O.value)===h);return D?D.value:h});L(e.key,c)},description:e.description,className:"mb-4",children:o.map(t=>s.jsx(I,{textValue:t.label,children:t.label},String(t.value)))},e.key)}case"html":return s.jsxs("div",{className:"mb-4",children:[e.label&&s.jsx("h4",{className:"text-small font-bold mb-1",children:e.label}),s.jsx("div",{dangerouslySetInnerHTML:{__html:e.default||""},className:"prose dark:prose-invert max-w-none"}),e.description&&s.jsx("p",{className:"text-tiny text-default-500 mt-1",children:e.description})]},e.key);case"text":return s.jsxs("div",{className:"mb-4",children:[e.label&&s.jsx("h4",{className:"text-small font-bold mb-1",children:e.label}),s.jsx("div",{className:"whitespace-pre-wrap text-default-700",children:e.default||""}),e.description&&s.jsx("p",{className:"text-tiny text-default-500 mt-1",children:e.description})]},e.key);default:return null}};return s.jsx(B,{isOpen:p,onOpenChange:y,size:"2xl",scrollBehavior:"inside",children:s.jsx(q,{children:e=>s.jsxs(s.Fragment,{children:[s.jsx(H,{className:"flex flex-col gap-1",children:s.jsxs("div",{className:"flex items-center gap-2",children:["æ’ä»¶é…ç½®: ",i,P&&s.jsx("span",{className:`text-tiny px-2 py-0.5 rounded ${E?"bg-success-100 text-success-600":"bg-warning-100 text-warning-600"}`,children:E?"å·²è¿æ¥":"æœªè¿æ¥"})]})}),s.jsx(G,{children:S?s.jsx("div",{className:"flex justify-center p-8",children:"Loading configuration..."}):s.jsx("div",{className:"flex flex-col gap-2",children:m.length===0?s.jsx("div",{className:"text-center text-default-500",children:"No configuration schema available."}):m.filter(l=>!l.hidden).map(K)})}),s.jsxs(Q,{children:[s.jsx(M,{color:"danger",variant:"light",onPress:e,children:"Close"}),s.jsx(M,{color:"primary",onPress:J,isLoading:g,children:"Save"})]})]})})})}function _e(){const[p,y]=r.useState([]),[i,S]=r.useState(!1),[w,m]=r.useState(!1),d=le(),{isOpen:b,onOpen:j,onOpenChange:g}=X(),[C,P]=r.useState(""),u=async()=>{S(!0),m(!1);try{const n=await v.getPluginList();n.pluginManagerNotFound?(m(!0),y([])):y(n.plugins)}catch(n){x.error(n.message)}finally{S(!1)}};r.useEffect(()=>{u()},[]);const N=async n=>{const f=n.status!=="active",F=f?"å¯ç”¨":"ç¦ç”¨",k=x.loading(`${F}ä¸­...`);try{await v.setPluginStatus(n.id,f),x.success(`${F}æˆåŠŸ`,{id:k}),u()}catch(R){x.error(R.message,{id:k})}},_=async n=>new Promise((f,F)=>{d.confirm({title:"å¸è½½æ’ä»¶",content:s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsxs("p",{children:["ç¡®å®šè¦å¸è½½æ’ä»¶ã€Œ",n.name,"ã€å—? æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚"]}),s.jsx("p",{className:"text-small text-default-500",children:"å¦‚æœæ’ä»¶åˆ›å»ºäº†æ•°æ®æ–‡ä»¶ï¼Œæ˜¯å¦ä¸€å¹¶åˆ é™¤ï¼Ÿ"})]}),onConfirm:async()=>{const k=window.confirm(`æ˜¯å¦åŒæ—¶æ¸…ç†æ’ä»¶ã€Œ${n.name}ã€çš„æ•°æ®æ–‡ä»¶ï¼Ÿ
ç‚¹å‡»â€œç¡®å®šâ€æ¸…ç†æ•°æ®ï¼Œç‚¹å‡»â€œå–æ¶ˆâ€ä»…å¸è½½æ’ä»¶ã€‚`),R=x.loading("å¸è½½ä¸­...");try{await v.uninstallPlugin(n.id,k),x.success("å¸è½½æˆåŠŸ",{id:R}),u(),f()}catch(z){x.error(z.message,{id:R}),F(z)}},onCancel:()=>{f()}})}),E=n=>{P(n.id),j()};return s.jsxs(s.Fragment,{children:[s.jsx("title",{children:"æ’ä»¶ç®¡ç† - NapCat WebUI"}),s.jsxs("div",{className:"p-2 md:p-4 relative",children:[s.jsx(Y,{loading:i}),s.jsx(re,{isOpen:b,onOpenChange:g,pluginId:C}),s.jsxs("div",{className:"flex mb-6 items-center gap-4",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"æ’ä»¶ç®¡ç†"}),s.jsx(M,{isIconOnly:!0,className:"bg-default-100/50 hover:bg-default-200/50 text-default-700 backdrop-blur-md",radius:"full",onPress:u,children:s.jsx(Z,{size:24})})]}),w?s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] text-center",children:[s.jsx("div",{className:"text-6xl mb-4",children:"ğŸ“¦"}),s.jsx("h2",{className:"text-xl font-semibold text-default-700 dark:text-white/90 mb-2",children:"æ— æ’ä»¶åŠ è½½"}),s.jsx("p",{className:"text-default-500 dark:text-white/60 max-w-md",children:"æ’ä»¶ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ plugins ç›®å½•æ˜¯å¦å­˜åœ¨"})]}):p.length===0?s.jsx("div",{className:"text-default-400",children:"æš‚æ—¶æ²¡æœ‰å®‰è£…æ’ä»¶"}):s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 justify-start items-stretch gap-x-2 gap-y-4",children:p.map(n=>s.jsx(ne,{data:n,onToggleStatus:()=>N(n),onUninstall:()=>_(n),onConfig:()=>{n.hasConfig?E(n):x.error("æ­¤æ’ä»¶æ²¡æœ‰é…ç½®å“¦")},hasConfig:!0},n.id))})]})]})}export{_e as default};
